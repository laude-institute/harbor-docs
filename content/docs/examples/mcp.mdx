---
title: "MCP Server Task"
description: How to create a task with MCP server support using task.toml and Docker Compose.
---

Harbor supports the [Model Context Protocol (MCP)](https://modelcontextprotocol.io/), allowing agents to connect to MCP servers and use their tools during task execution. MCP servers are declared in `task.toml` and Harbor automatically configures supported agents (Claude Code, Codex) to connect to them.

The full source for this example is in [`examples/tasks/hello-mcp`](https://github.com/laude-institute/harbor/tree/main/examples/tasks/hello-mcp).

## Declaring MCP servers in `task.toml`

Add one or more `[[environment.mcp_servers]]` entries to your `task.toml`:

```toml title="task.toml"
version = "1.0"

[environment]
build_timeout_sec = 600.0
cpus = 1
memory_mb = 2048
storage_mb = 10240
gpus = 0
allow_internet = true

[[environment.mcp_servers]]
name = "mcp-server"
transport = "streamable-http"
url = "http://mcp-server:8000/mcp"
```

When a task declares MCP servers, Harbor passes them to the agent at runtime. Agents that support MCP (currently **Claude Code** and **Codex**) automatically write the appropriate configuration so they can discover and call the server's tools.

### MCP server fields

import { TypeTable } from 'fumadocs-ui/components/type-table';

<TypeTable
  type={{
    "name": {
      description: "Unique identifier for the MCP server.",
      type: "string",
      required: true,
    },
    "transport": {
      description: 'Transport protocol. One of "sse", "streamable-http", or "stdio".',
      type: "string",
      default: '"sse"',
    },
    "url": {
      description: "Server endpoint URL. Required for sse and streamable-http transports.",
      type: "string | null",
      default: "null",
    },
    "command": {
      description: "Command to launch the server. Required for stdio transport.",
      type: "string | null",
      default: "null",
    },
    "args": {
      description: "Arguments passed to the command (stdio transport only).",
      type: "list[string]",
      default: "[]",
    },
  }}
/>

### Transport types

| Transport | Required fields | Description |
|-----------|----------------|-------------|
| `sse` | `url` | Server-Sent Events over HTTP. |
| `streamable-http` | `url` | HTTP streaming protocol. |
| `stdio` | `command`, `args` (optional) | Launches a local process and communicates over stdin/stdout. |

**Examples for each transport:**

```toml title="SSE"
[[environment.mcp_servers]]
name = "my-server"
transport = "sse"
url = "http://mcp-server:8000/sse"
```

```toml title="Streamable HTTP"
[[environment.mcp_servers]]
name = "my-server"
transport = "streamable-http"
url = "http://mcp-server:8000/mcp"
```

```toml title="stdio"
[[environment.mcp_servers]]
name = "my-server"
transport = "stdio"
command = "npx"
args = ["-y", "my-mcp-server"]
```

## Multi-container environments

When the MCP server runs as a sidecar container (the most common pattern), you need a multi-container environment. Harbor's `--env docker` environment supports this by reading a `docker-compose.yaml` from the `environment/` directory.

import { Callout } from 'fumadocs-ui/components/callout';

<Callout type="info" title="Docker only">
Multi-container tasks currently only work with the local Docker environment (`--env docker`). Cloud sandbox providers (Modal, Daytona, E2B) only support single-Dockerfile environments.
</Callout>

## Example: hello-mcp

This task asks the agent to connect to an MCP server, call a tool, and write the result to a file.

### Directory structure

```
hello-mcp/
├── instruction.md
├── task.toml
├── environment/
│   ├── Dockerfile                 # Agent container
│   ├── docker-compose.yaml        # Compose override (adds MCP server)
│   └── mcp-server/
│       ├── Dockerfile             # MCP server container
│       └── server.py              # FastMCP server
├── solution/
│   └── solve.sh
└── tests/
    ├── test.sh
    └── test_outputs.py
```

### Docker Compose sidecar

Place a `docker-compose.yaml` in the `environment/` directory. Harbor merges it with its base compose config automatically.

```yaml title="environment/docker-compose.yaml"
services:
  main:
    depends_on:
      mcp-server:
        condition: service_healthy

  mcp-server:
    build:
      context: ./mcp-server
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-Isf", "http://localhost:8000/sse"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 5s
```

- `main` is the agent's container — Harbor configures it automatically. You only add overrides like `depends_on`.
- Additional services (here `mcp-server`) are defined normally. They share a Docker network with `main`, so the agent can reach them by service name.

### MCP server

The server uses [FastMCP](https://github.com/jlowin/fastmcp) and exposes a single tool over SSE:

```python title="environment/mcp-server/server.py"
from fastmcp import FastMCP

mcp = FastMCP("hello-mcp")

SECRET_VALUE = "harbor-mcp-secret-12345"

@mcp.tool()
def get_secret() -> str:
    """Returns a secret value."""
    return SECRET_VALUE

if __name__ == "__main__":
    mcp.run(transport="sse", host="0.0.0.0", port=8000)
```

### Instruction

```markdown title="instruction.md"
There is an MCP server running at `http://mcp-server:8000/sse`
that exposes a tool called `get_secret`.

1. Connect to the MCP server
2. Call the `get_secret` tool
3. Write the returned secret value to `/app/secret.txt`
```

### Verification

The test script runs a pytest check that compares the file contents to the expected secret:

```python title="tests/test_outputs.py"
SECRET_VALUE = "harbor-mcp-secret-12345"

def test_secret_file_exists():
    with open("/app/secret.txt") as f:
        content = f.read()
    assert content.strip() == SECRET_VALUE
```

### Running it

```bash
# Verify with the oracle agent (runs solution/solve.sh)
harbor run -p examples/tasks/hello-mcp -a oracle

# Test with a real agent
harbor run -p examples/tasks/hello-mcp -a claude-code -m anthropic/claude-sonnet-4-5
```

## How agents receive MCP configuration

When you declare MCP servers in `task.toml`, Harbor handles wiring them to supported agents automatically:

- **Claude Code** — MCP servers are written to `~/.claude.json` under the `mcpServers` key. The `streamable-http` transport is converted to Claude Code's native `http` format.
- **Codex** — MCP servers are written to `config.toml` under `mcp_servers` sections in the Codex configuration directory.

Agents that don't have built-in MCP support can still use MCP servers manually by connecting with an MCP client library — the server URL and transport are described in the task instruction.
